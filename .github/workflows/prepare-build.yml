name: Prepare Build

on:
  workflow_call:
    inputs:
      run-static-analysis:
        description: Whether to run static analysis checks
        type: boolean
      fetch-latest-python:
        description: Whether to fetch the latest supported Python version
        type: boolean
    outputs:
      sdist-name:
        description: Name of the source distribution file
        value: "${{ jobs.prepare.outputs.sdist-name }}"
      latest-supported-python:
        description: Latest supported Python version
        value: "${{ jobs.prepare.outputs.latest-supported-python }}"

jobs:
  prepare:
    name: Prepare build ${{ inputs.run-static-analysis && 'with static analysis' || '' }}
    runs-on: ubuntu-latest

    outputs:
      sdist-name: "${{ steps.build-sdist.outputs.file-name }}"
      latest-supported-python: "${{ steps.latest-supported-python.outputs.version }}"

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Fetch release history
      uses: ./.github/actions/fetch-release-history
      with:
        github-token: "${{ github.token }}"

    - name: Load environment file
      uses: ./.github/actions/load-env

    - name: Install Python
      uses: actions/setup-python@v6
      with:
        python-version-file: pyproject.toml

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Install command runner
      if: inputs.run-static-analysis
      run: uv tool install rust-just

    - name: Install static analysis dependencies
      if: inputs.run-static-analysis
      run: just env-sync hooks

    - name: Run hooks
      if: inputs.run-static-analysis
      run: just hooks-check

    - name: Derive version from git tag (if applicable)
      id: tag-version
      shell: bash
      run: |-
        set -euo pipefail

        tag=""
        # Release workflow: GitHub provides the release tag explicitly
        if [[ "${{ github.event_name }}" == "release" && "${{ github.event.action }}" == "published" ]]; then
          tag="${{ github.event.release.tag_name }}"
        # Tag push workflow (if enabled later)
        elif [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
          tag="${GITHUB_REF_NAME:-}"
        fi

        # Strip common leading "v" prefix
        tag="${tag#v}"

        if [[ -n "$tag" ]]; then
          echo "Using tag-derived version: $tag"
        else
          echo "No tag detected; setuptools-scm will generate a dev version."
        fi

        echo "version=$tag" >> "$GITHUB_OUTPUT"

    - name: Build source distribution
      id: build-sdist
      run: |-
        # If we're building from a tag/release, force the version to match the tag.
        # This avoids publishing dev versions to PyPI.
        if [[ -n "${{ steps.tag-version.outputs.version }}" ]]; then
          export SETUPTOOLS_SCM_PRETEND_VERSION="${{ steps.tag-version.outputs.version }}"
        fi
        uv build --sdist
        sdist_name=$(basename dist/*.tar.gz)
        echo "file-name=${sdist_name}" >> $GITHUB_OUTPUT

    - name: Upload artifact
      uses: actions/upload-artifact@v5
      with:
        name: artifact-sdist
        path: dist/${{ steps.build-sdist.outputs.file-name }}
        if-no-files-found: error

    - name: Fetch latest supported Python
      if: inputs.fetch-latest-python
      id: latest-supported-python
      uses: ./.github/actions/latest-supported-python
      with:
        github-token: "${{ github.token }}"
